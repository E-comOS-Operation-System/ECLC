# ECLC Installation Script - Cross-Platform PowerShell
# Works on Windows, Linux, macOS

Write-Host "Installing ECLC - E-comOS C/C++ Language Compiler..." -ForegroundColor Green

# Detect operating system
if ($PSVersionTable.PSVersion.Major -ge 6) {
    # PowerShell Core 6+ has built-in variables
    $OSWindows = $IsWindows
    $OSLinux = $IsLinux
    $OSMacOS = $IsMacOS
} else {
    # Windows PowerShell 5.1
    $OSWindows = $env:OS -eq "Windows_NT"
    $OSLinux = $false
    $OSMacOS = $false
}

Write-Host "Detected OS: $(if($OSWindows){'Windows'}elseif($OSLinux){'Linux'}elseif($OSMacOS){'macOS'}else{'Unknown'})" -ForegroundColor Cyan

# Check if we have a C compiler
try {
    $null = Get-Command gcc -ErrorAction Stop
    Write-Host "✅ GCC found" -ForegroundColor Green
} catch {
    Write-Host "❌ GCC not found. Please install:" -ForegroundColor Red
    if ($OSWindows) {
        Write-Host "  - MinGW-w64: https://www.mingw-w64.org/" -ForegroundColor Yellow
        Write-Host "  - MSYS2: https://www.msys2.org/" -ForegroundColor Yellow
    } elseif ($OSLinux) {
        Write-Host "  - Ubuntu/Debian: sudo apt install build-essential" -ForegroundColor Yellow
        Write-Host "  - CentOS/RHEL: sudo yum install gcc make" -ForegroundColor Yellow
    } elseif ($OSMacOS) {
        Write-Host "  - Xcode Command Line Tools: xcode-select --install" -ForegroundColor Yellow
        Write-Host "  - Homebrew: brew install gcc" -ForegroundColor Yellow
    }
    exit 1
}

# Build the compiler
Write-Host "Building ECLC..." -ForegroundColor Cyan
& make clean
& make

if ($LASTEXITCODE -ne 0) {
    Write-Host "Error: Build failed. Make sure you have make and gcc installed." -ForegroundColor Red
    exit 1
}

# Create installation directory based on OS
if ($OSWindows) {
    $InstallDir = "$env:USERPROFILE\.local\bin"
    $BinaryName = "eclc.exe"
} else {
    # Linux/macOS
    if (Test-Path "/usr/local/bin" -PathType Container) {
        try {
            $TestFile = "/usr/local/bin/.test_write_$(Get-Random)"
            $null = New-Item -Path $TestFile -ItemType File -Force
            Remove-Item $TestFile -Force
            $InstallDir = "/usr/local/bin"
        } catch {
            $InstallDir = "$env:HOME/.local/bin"
        }
    } else {
        $InstallDir = "$env:HOME/.local/bin"
    }
    $BinaryName = "eclc"
}

if (!(Test-Path $InstallDir)) {
    New-Item -ItemType Directory -Path $InstallDir -Force | Out-Null
}

# Install binary
Write-Host "Installing to $InstallDir..." -ForegroundColor Cyan
$SourceBinary = if (Test-Path "bin/eclc.exe") { "bin/eclc.exe" } else { "bin/eclc" }
$TargetPath = Join-Path $InstallDir $BinaryName
Copy-Item $SourceBinary $TargetPath -Force

if (!$OSWindows) {
    # Make executable on Unix-like systems
    & chmod +x $TargetPath
}

# Add to PATH if not already there
if ($OSWindows) {
    $CurrentPath = [Environment]::GetEnvironmentVariable("PATH", "User")
    if ($CurrentPath -notlike "*$InstallDir*") {
        Write-Host "Adding $InstallDir to your PATH..." -ForegroundColor Cyan
        [Environment]::SetEnvironmentVariable("PATH", "$CurrentPath;$InstallDir", "User")
        Write-Host "PATH updated. Please restart your terminal." -ForegroundColor Yellow
    }
} else {
    # Unix-like systems
    $ShellProfile = if (Test-Path "$env:HOME/.zshrc") { "$env:HOME/.zshrc" } else { "$env:HOME/.bashrc" }
    $PathExport = "export PATH=`"${InstallDir}:`$PATH`""
    
    if ($InstallDir -ne "/usr/local/bin") {
        $ProfileContent = if (Test-Path $ShellProfile) { Get-Content $ShellProfile -Raw } else { "" }
        if ($ProfileContent -notlike "*$InstallDir*") {
            Write-Host "Adding $InstallDir to your PATH in $ShellProfile..." -ForegroundColor Cyan
            Add-Content -Path $ShellProfile -Value "`n# ECLC Compiler`n$PathExport"
            Write-Host "PATH updated. Run 'source $ShellProfile' or restart your terminal." -ForegroundColor Yellow
        }
    }
}

Write-Host ""
Write-Host "✅ ECLC installed successfully!" -ForegroundColor Green
Write-Host ""
Write-Host "Usage: eclc file.c [-o output] | eclc -f folder" -ForegroundColor White